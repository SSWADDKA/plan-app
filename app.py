import streamlit as st
import google.generativeai as genai
from docxtpl import DocxTemplate
import io
import re

# --- 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ---
SUBJECTS_DATA = {
    "‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤": ["‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", "‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ø", "‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ø", "‡∏®‡∏¥‡∏•‡∏õ‡∏∞", "‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û", "‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©"],
    "‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô": ["‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô", "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì", "‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ø", "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏®‡∏¥‡∏•‡∏õ‡∏∞", "‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û", "‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô"],
    "‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢": ["‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô", "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô", "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°", "‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå", "‡πÄ‡∏Ñ‡∏°‡∏µ", "‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤", "‡πÇ‡∏•‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏ß‡∏Å‡∏≤‡∏®", "‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ø", "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏®‡∏¥‡∏•‡∏õ‡∏∞", "‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û", "‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô", "‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì", "‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ"]
}

KPA_OPTIONS = {
    "K (Knowledge)": ["‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à", "‡∏Å‡∏≤‡∏£‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£", "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤"],
    "P (Process)": ["‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥", "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°"],
    "A (Attitude)": ["‡πÉ‡∏ù‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ", "‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "‡∏°‡∏µ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢"]
}

# --- 2. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ UI (Blue Theme) ---
st.set_page_config(layout="wide", page_title="PLAN - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô")

st.markdown("""
    <style>
    .stApp { background-color: #eef2f7; }
    [data-testid="stSidebar"] { width: 480px !important; background-color: #ffffff; border-right: 3px solid #3498db; }
    .paper-page {
        background-color: white; padding: 60px 80px; border: 1px solid #d1d1d1;
        box-shadow: 0 15px 35px rgba(52, 152, 219, 0.15); color: #2c3e50; line-height: 1.8;
        border-top: 10px solid #3498db; border-radius: 5px;
    }
    .plan-header { text-align: center; border-bottom: 2px solid #3498db; margin-bottom: 30px; padding-bottom: 15px; }
    .plan-header h3 { color: #2980b9; font-weight: bold; }
    div.stButton > button { 
        width: 100%; border-radius: 12px; height: 3.8em; background-color: #3498db; color: #fff; font-weight: bold; border: none;
        transition: 0.3s; box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3);
    }
    div.stButton > button:hover { background-color: #2980b9; transform: translateY(-2px); }
    .section-title { color: #2980b9; font-weight: bold; font-size: 1.2em; margin-top: 1em; }
    </style>
    """, unsafe_allow_html=True)

def clean_for_preview(text):
    text = re.sub(r'[#*_]{1,3}', '', text)
    return text.strip()

# --- 3. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ---
GOOGLE_API_KEY = st.secrets["GOOGLE_API_KEY"]
genai.configure(api_key=GOOGLE_API_KEY)
model = genai.GenerativeModel('gemini-2.5-flash')

# --- 4. SIDEBAR ---
with st.sidebar:
    st.image("https://cdn-icons-png.flaticon.com/512/3534/3534033.png", width=80)
    st.title("üíô PLAN AI Teacher")
    
    with st.form("input_form"):
        school = st.text_input("üìç ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")
        teacher = st.text_input("üë®‚Äçüè´ ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô")
        term = st.text_input("üìÖ ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", value="1 / 2567")
        grade_level = st.selectbox("üéì ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", list(SUBJECTS_DATA.keys()))
        subject = st.selectbox("üìö ‡∏ß‡∏¥‡∏ä‡∏≤", SUBJECTS_DATA[grade_level])
        
        col1, col2 = st.columns(2)
        with col1:
            code = st.text_input("üî¢ ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤")
            grade = st.text_input("üè´ ‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ")
        with col2:
            time = st.text_input("‚è≥ ‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)", value="2")
            
        topic = st.text_input("üí° ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")
        extra_skills = st.text_area("üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©", height=70)
        sel_k = st.multiselect("Knowledge (K)", KPA_OPTIONS["K (Knowledge)"])
        sel_p = st.multiselect("Process (P)", KPA_OPTIONS["P (Process)"])
        sel_a = st.multiselect("Attitude (A)", KPA_OPTIONS["A (Attitude)"])
        
        submitted = st.form_submit_button("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô")

# --- 5. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ---
if submitted:
    with st.spinner('üíé AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì...'):
        prompt = f"""‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á {topic} ‡∏ß‡∏¥‡∏ä‡∏≤ {subject} ({code}) ‡∏ä‡∏±‡πâ‡∏ô {grade} ‡πÄ‡∏ô‡πâ‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞ {extra_skills} ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå KPA: {sel_k}, {sel_p}, {sel_a} ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á: ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ, ‡∏™‡∏≤‡∏£‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç, ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå, ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Active Learning), ‡∏™‡∏∑‡πà‡∏≠, ‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏π‡∏ö‡∏£‡∏¥‡∏Å‡∏™‡πå (Markdown Table) ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏¢‡∏≠‡∏∞"""
        response = model.generate_content(prompt)
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô KeyError
        st.session_state['ai_raw'] = response.text
        st.session_state['data_context'] = {
            'school': school, 'teacher': teacher, 'term': term,
            'subject': subject, 'code': code, 'grade': grade,
            'topic': topic, 'time': time
        }

# --- 6. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error) ---
if 'ai_raw' in st.session_state and 'data_context' in st.session_state:
    doc_data = st.session_state['data_context']
    
    c1, c2 = st.columns([8, 2])
    with c2:
        try:
            doc = DocxTemplate("template.docx")
            final_data = {**doc_data, 'ai_content': clean_for_preview(st.session_state['ai_raw'])}
            doc.render(final_data)
            bio = io.BytesIO()
            doc.save(bio)
            st.download_button("üìò ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Word", bio.getvalue(), f"‡πÅ‡∏ú‡∏ô_{doc_data['topic']}.docx")
        except: 
            st.warning("‚ö†Ô∏è ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î template.docx")

    st.markdown('<div class="paper-page">', unsafe_allow_html=True)
    st.markdown(f"""
        <div class="plan-header">
            <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h3>
            <p style="font-size: 1.2em; color: #2980b9;"><b>{doc_data['school']}</b></p>
            <p>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà {doc_data['term']}</p>
            <p><b>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á:</b> {doc_data['topic']}</p>
            <p>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤ {doc_data['code']} ‡∏ß‡∏¥‡∏ä‡∏≤ {doc_data['subject']} ‡∏ä‡∏±‡πâ‡∏ô {doc_data['grade']} ‡πÄ‡∏ß‡∏•‡∏≤ {doc_data['time']} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
            <p><b>‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô:</b> {doc_data['teacher']}</p>
        </div>
    """, unsafe_allow_html=True)

    preview_text = clean_for_preview(st.session_state['ai_raw'])
    st.markdown(preview_text)
    
    with st.expander("üõ†Ô∏è ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"):
        st.session_state['ai_raw'] = st.text_area("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏ú‡∏ô:", value=st.session_state['ai_raw'], height=400)
    st.markdown('</div>', unsafe_allow_html=True)
else:
    # ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô Error
    st.info("üëã ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö PLAN! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö")